dmake_version: 0.1
app_name: nutanix-runtime
env:
  default:
    source: ${DEEPOMATIC_CONFIG_DIR}/dev.sh
    variables:
      NEURAL_WORKER_VERSION: deepomatic/vulcan-worker-nn-on-premises-rc:master-495-combo
      RESOURCE_SERVER_VERSION: deepomatic/resource-server-on-premises-rc:master2-2
      NUTANIX_RUNTIME_APP_ID: ${NUTANIX_RUNTIME_APP_ID}
      NUTANIX_RUNTIME_API_KEY: ${NUTANIX_RUNTIME_API_KEY}
      NUTANIX_RUNTIME_SITE_ID: ${NUTANIX_RUNTIME_SITE_ID}
      NUTANIX_RUNTIME_VOUCHER: ${NUTANIX_RUNTIME_VOUCHER}

      NATS_SRC_TOPIC_IMAGE: src_image
      NATS_DST_TOPIC_IMAGE: dst_image
      NATS_SRC_TOPIC_JSON: src_json
      NATS_DST_TOPIC_JSON: dst_json

# This deprecated (but currently required so we put a placeholder)
docker:
  base_image:
    name: nutanix-app-base
    root_image: python:3.6
    install_scripts:
      - deploy/base/install.sh
    copy_files:
      - deploy/base/requirements.txt


volumes:
  - control
  - resource-server


docker_links:
  - image_name: nats:1.4.1-linux
    link_name: nats
    probe_ports:
      - 4222/tcp
    env_exports:
      NATS_ENDPOINT: nats:4222
  - image_name: rabbitmq:3.6
    link_name: rabbitmq
    probe_ports:
      - 5672/tcp
    env:
      RABBITMQ_DEFAULT_USER: user
      RABBITMQ_DEFAULT_PASS: password
      RABBITMQ_DEFAULT_VHOST: nutanix
    env_exports:
      AMQP_URL: amqp://user:password@rabbitmq:5672/nutanix

services:
  - service_name: runtime
    needed_services:
      - neural-worker
    needed_links:
      - rabbitmq
      - nats
    config:
      docker_image:
        name: deepomatic/nutanix-runtime
        build:
          context: runtime
          dockerfile: Dockerfile
          labels:
            vendor: deepomatic
      env_override:
        DRAW_DEMO: 0
        FONT_COLOR: 4286f4
    deploy:
      stages:
        - description: Deploying on Kubernetes
          branches:
            - master
            - dev-show-http
          kubernetes:
            context: main
            namespace: dev
            manifest:
              template: deploy/k8s-manifest.yml
              variables:
                NEURAL_WORKER_VERSION: ${NEURAL_WORKER_VERSION}
                RESOURCE_SERVER_VERSION: ${RESOURCE_SERVER_VERSION}
                DEEPOMATIC_APP_ID: ${NUTANIX_RUNTIME_APP_ID}
                DEEPOMATIC_API_KEY: ${NUTANIX_RUNTIME_API_KEY}
                DEEPOMATIC_SITE_ID: ${NUTANIX_RUNTIME_SITE_ID}
                NUTANIX_RUNTIME_VOUCHER: ${NUTANIX_RUNTIME_VOUCHER}
                DEPLOYMENT_NAME: nutanix-app
                DOCKER_HUB_SECRET_NAME: "imagePullSecrets: [{name: docker-hub}]"
                NATS_SERVICE: "- {name: nats, image: nats:1.4.1-linux}"
                NATS_ENDPOINT: "- {name: NATS_ENDPOINT, value: localhost:4222}"
                NATS_SRC_TOPIC: "- {name: NATS_SRC_TOPIC, value: foo}"
                NATS_DST_TOPIC: "- {name: NATS_DST_TOPIC, value: bar}"

  - service_name: e2e-test
    needed_services:
      - service_name: runtime
        env:
          DRAW_DEMO: 1
          FONT_COLOR: 4286f4
          NATS_SRC_TOPIC: ${NATS_SRC_TOPIC_IMAGE}
          NATS_DST_TOPIC: ${NATS_DST_TOPIC_IMAGE}
          PROCESS_EACH_N_FRAMES: 8
      - service_name: runtime
        env:
          NATS_SRC_TOPIC: ${NATS_SRC_TOPIC_JSON}
          NATS_DST_TOPIC: ${NATS_DST_TOPIC_JSON}
    needed_links:
      - nats
    tests:
      timeout: 60
      commands:
        - python tests/e2e_test.py

  - service_name: neural-worker
    needed_links:
      - rabbitmq
    needed_services:
      - resource-server
    config:
      docker_image: ${NEURAL_WORKER_VERSION}
      env_override:
        ALLOW_NO_GPU: 1
        AUTOSTART_WORKER: 'false'
        MODEL_LOCAL_ROOT: /var/lib/deepomatic/resource-server/resources
        LICENSE_FILENAME: /var/lib/deepomatic/resource-server/resources/license.bin
        WORKFLOWS_PATH: /var/lib/deepomatic/resource-server/resources/workflows.json
      readiness_probe:
        command:
          - ls
          - /tmp/worker-nn-ready
        period_seconds: 5
      volumes:
        - control:/var/lib/deepomatic/control
        - resource-server:/var/lib/deepomatic/resource-server

  - service_name: resource-server
    config:
      docker_image: ${RESOURCE_SERVER_VERSION}
      env_override:
        DEEPOMATIC_API_URL: https://api.deepomatic.com
        DEEPOMATIC_APP_ID: ${NUTANIX_RUNTIME_APP_ID}
        DEEPOMATIC_API_KEY: ${NUTANIX_RUNTIME_API_KEY}
        DEEPOMATIC_SITE_ID: ${NUTANIX_RUNTIME_SITE_ID}
        DOWNLOAD_ON_STARTUP: 1
        INIT_SYSTEM: circus
        NUTANIX_RUNTIME_VOUCHER: ${NUTANIX_RUNTIME_VOUCHER}
      readiness_probe:
        command:
          - ls
          - /tmp/resource-server-ready
        period_seconds: 5
      volumes:
        - control:/var/lib/deepomatic/control
        - resource-server:/var/lib/deepomatic/resource-server
